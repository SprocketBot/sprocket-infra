version: '3.8'

networks:
  layer1_traefik-ingress:
    external: true
  layer2_monitoring-network:
    external: true
  layer2_postgres-network:
    external: true
  platform-network:
    driver: overlay
    attachable: true

volumes:
  platform-redis-data:
  rabbitmq-data:

configs:
  platform-redis-config:
    file: ../platform/src/config/datastores/redis.conf
  rabbitmq-config:
    file: ../platform/src/config/datastores/rabbitmq.conf


services:
  # Platform Datastores
  platform-redis:
    image: redislabs/rejson:2.0.7
    command: >
      --requirepass ${REDIS_PASSWORD}
      --loadmodule /usr/lib/redis/modules/rejson.so
      --loadmodule /usr/lib/redis/modules/redisearch.so
    volumes:
      - platform-redis-data:/data
    networks:
      - platform-network
      - layer1_traefik-ingress
    configs:
      - source: platform-redis-config
        target: /usr/local/etc/redis/redis.conf
    deploy:
      placement:
        constraints:
          - node.labels.role == storage
      labels:
        - "traefik.enable=true"
        - "traefik.tcp.routers.platform-redis.rule=HostSNI(`redis.${ENVIRONMENT_SUBDOMAIN}.${HOSTNAME}`)"
        - "traefik.tcp.routers.platform-redis.tls.certresolver=lets-encrypt-tls"
        - "traefik.tcp.services.platform-redis.loadbalancer.server.port=6379"

  rabbitmq:
    image: rabbitmq:3.9.14-management-alpine
    hostname: "{{.Node.Hostname}}"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - platform-network
      - layer1_traefik-ingress
    configs:
      - source: rabbitmq-config
        target: /etc/rabbitmq/rabbitmq.conf
    deploy:
      placement:
        constraints:
          - node.labels.role == storage
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.rabbitmq-management.rule=Host(`management.rabbitmq.${ENVIRONMENT_SUBDOMAIN}.${HOSTNAME}`)"
        - "traefik.http.routers.rabbitmq-management.entrypoints=websecure"
        - "traefik.http.routers.rabbitmq-management.tls.certresolver=lets-encrypt-tls"
        - "traefik.http.services.rabbitmq-management.loadbalancer.server.port=15672"
        - "traefik.tcp.routers.rabbitmq-amqp.rule=HostSNI(`rabbitmq.${ENVIRONMENT_SUBDOMAIN}.${HOSTNAME}`)"
        - "traefik.tcp.routers.rabbitmq-amqp.tls.certresolver=lets-encrypt-tls"
        - "traefik.tcp.services.rabbitmq-amqp.loadbalancer.server.port=5672"

  # Core Platform Services
  sprocket-core:
    image: asaxplayinghorse/core:${IMAGE_TAG}
    environment:
      # Authentication - Google OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_SECRET: ${GOOGLE_SECRET}
      GOOGLE_CALLBACK_URL: ${GOOGLE_CALLBACK_URL}
      # Authentication - Discord OAuth
      DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID}
      DISCORD_SECRET: ${DISCORD_SECRET}
      DISCORD_CALLBACK_URL: ${DISCORD_CALLBACK_URL}
      # Authentication - JWT
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRY: ${JWT_EXPIRY}
      ACCESS_EXPIRY: ${ACCESS_EXPIRY}
      REFRESH_EXPIRY: ${REFRESH_EXPIRY}
      FRONTEND_CALLBACK: ${FRONTEND_CALLBACK}
      # Bot Configuration
      BOT_PREFIX: ${BOT_PREFIX}
      # Database Configuration
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE: ${DB_DATABASE}
      DB_ENABLE_LOGS: ${DB_ENABLE_LOGS}
      # Redis/Cache Configuration
      REDIS_HOST: platform-redis
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_PREFIX: ${REDIS_PREFIX}
      REDIS_SECURE: ${REDIS_SECURE}
      CACHE_HOST: ${CACHE_HOST}
      CACHE_PORT: ${CACHE_PORT}
      CACHE_PASSWORD: ${CACHE_PASSWORD}
      CACHE_SECURE: ${CACHE_SECURE}
      # MinIO Object Storage
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_PORT: ${MINIO_PORT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_USE_SSL: ${MINIO_USE_SSL}
      MINIO_REPLAYS_BUCKET: ${MINIO_REPLAYS_BUCKET}
      MINIO_IMAGE_GENERATION_BUCKET: ${MINIO_IMAGE_GENERATION_BUCKET}
      # Transport/Message Queue
      TRANSPORT_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      CELERY_BROKER: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      CELERY_QUEUE: ${CELERY_QUEUE}
      TRANSPORT_CORE_QUEUE: ${TRANSPORT_CORE_QUEUE}
      TRANSPORT_BOT_QUEUE: ${TRANSPORT_BOT_QUEUE}
      TRANSPORT_ANALYTICS_QUEUE: ${TRANSPORT_ANALYTICS_QUEUE}
      TRANSPORT_MATCHMAKING_QUEUE: ${TRANSPORT_MATCHMAKING_QUEUE}
      TRANSPORT_NOTIFICATION_QUEUE: ${TRANSPORT_NOTIFICATION_QUEUE}
      TRANSPORT_EVENTS_QUEUE: ${TRANSPORT_EVENTS_QUEUE}
      TRANSPORT_EVENTS_APPLICATION_KEY: ${TRANSPORT_EVENTS_APPLICATION_KEY}
      TRANSPORT_IMAGE_GENERATION_QUEUE: ${TRANSPORT_IMAGE_GENERATION_QUEUE}
      TRANSPORT_SUBMISSION_QUEUE: ${TRANSPORT_SUBMISSION_QUEUE}
      # Web Configuration
      WEB_URL: ${WEB_URL}
      WEB_API_ROOT: ${WEB_API_ROOT}
      # Web Client Configuration
      CLIENT_GQL_URL: ${CLIENT_GQL_URL}
      CLIENT_SECURE: ${CLIENT_SECURE}
      CLIENT_CHATWOOT_ENABLED: ${CLIENT_CHATWOOT_ENABLED}
      CLIENT_CHATWOOT_URL: ${CLIENT_CHATWOOT_URL}
      CLIENT_CHATWOOT_WEBSITE_TOKEN: ${CLIENT_CHATWOOT_WEBSITE_TOKEN}
      # Chatwoot Integration
      CHATWOOT_HMAC_KEY: ${CHATWOOT_HMAC_KEY}
      # GraphQL Configuration
      GQL_URL: ${GQL_URL}
      GQL_PLAYGROUND: ${GQL_PLAYGROUND}
      # Logging
      LOGGER_LEVELS: ${LOGGER_LEVELS}
      # Default Organization
      DEFAULT_ORGANIZATION_ID: ${DEFAULT_ORGANIZATION_ID}
    networks:
      - platform-network
      - layer1_traefik-ingress
      - layer2_postgres-network
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.sprocket-core.rule=Host(`api.${ENVIRONMENT_SUBDOMAIN}.${HOSTNAME}`)"
        - "traefik.http.routers.sprocket-core.entrypoints=websecure"
        - "traefik.http.routers.sprocket-core.tls.certresolver=lets-encrypt-tls"
        - "traefik.http.services.sprocket-core.loadbalancer.server.port=3001"

  sprocket-web:
    image: asaxplayinghorse/web:${IMAGE_TAG}
    environment:
      # Web Configuration
      WEB_URL: ${WEB_URL}
      WEB_API_ROOT: ${WEB_API_ROOT}
      # Web Client Configuration
      CLIENT_GQL_URL: ${CLIENT_GQL_URL}
      CLIENT_SECURE: ${CLIENT_SECURE}
      CLIENT_CHATWOOT_ENABLED: ${CLIENT_CHATWOOT_ENABLED}
      CLIENT_CHATWOOT_URL: ${CLIENT_CHATWOOT_URL}
      CLIENT_CHATWOOT_WEBSITE_TOKEN: ${CLIENT_CHATWOOT_WEBSITE_TOKEN}
      # Chatwoot Integration
      CHATWOOT_HMAC_KEY: ${CHATWOOT_HMAC_KEY}
      # GraphQL Configuration
      GQL_URL: ${GQL_URL}
      GQL_PLAYGROUND: ${GQL_PLAYGROUND}
    networks:
      - layer1_traefik-ingress
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.sprocket-web.rule=Host(`${ENVIRONMENT_SUBDOMAIN}.${HOSTNAME}`)"
        - "traefik.http.routers.sprocket-web.entrypoints=websecure"
        - "traefik.http.routers.sprocket-web.tls.certresolver=lets-encrypt-tls"
        - "traefik.http.services.sprocket-web.loadbalancer.server.port=3000"

  discord-bot:
    image: asaxplayinghorse/discord-bot:${IMAGE_TAG}
    environment:
      # Bot Configuration
      BOT_PREFIX: ${BOT_PREFIX}
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN}
      # MinIO Object Storage
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_PORT: ${MINIO_PORT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_USE_SSL: ${MINIO_USE_SSL}
      MINIO_REPLAYS_BUCKET: ${MINIO_REPLAYS_BUCKET}
      MINIO_IMAGE_GENERATION_BUCKET: ${MINIO_IMAGE_GENERATION_BUCKET}
      # Transport/Message Queue
      TRANSPORT_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      CELERY_BROKER: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      CELERY_QUEUE: ${CELERY_QUEUE}
      TRANSPORT_BOT_QUEUE: ${TRANSPORT_BOT_QUEUE}
      TRANSPORT_SUBMISSION_QUEUE: ${TRANSPORT_ANALYTICS_QUEUE}
      TRANSPORT_MATCHMAKING_QUEUE: ${TRANSPORT_MATCHMAKING_QUEUE}
      TRANSPORT_ANALYTICS_QUEUE: ${TRANSPORT_ANALYTICS_QUEUE}
      TRANSPORT_IMAGE_GENERATION_QUEUE: ${TRANSPORT_IMAGE_GENERATION_QUEUE}
      TRANSPORT_CORE_QUEUE: ${TRANSPORT_CORE_QUEUE}
      TRANSPORT_EVENTS_QUEUE: ${TRANSPORT_EVENTS_QUEUE}
      TRANSPORT_NOTIFICATION_QUEUE: ${TRANSPORT_NOTIFICATION_QUEUE}

      # GraphQL Configuration
      GQL_URL: ${GQL_URL}
      # Logging
      LOGGER_LEVELS: ${LOGGER_LEVELS}
    networks:
      - platform-network
    deploy:
      labels:
        - "traefik.enable=false"

  # Frontend Services
  image-generation-frontend:
    image: asaxplayinghorse/image-generation-frontend:${IMAGE_TAG}
    environment:
      # Database Configuration
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE: ${DB_DATABASE}
      # MinIO Object Storage
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_PORT: ${MINIO_PORT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_USE_SSL: ${MINIO_USE_SSL}
      MINIO_IMAGE_GENERATION_BUCKET: ${MINIO_IMAGE_GENERATION_BUCKET}
      TRANSPORT_MATCHMAKING_QUEUE: ${TRANSPORT_MATCHMAKING_QUEUE}
      TRANSPORT_ANALYTICS_QUEUE: ${TRANSPORT_ANALYTICS_QUEUE}
      TRANSPORT_IMAGE_GENERATION_QUEUE: ${TRANSPORT_IMAGE_GENERATION_QUEUE}
      TRANSPORT_BOT_QUEUE: ${TRANSPORT_BOT_QUEUE}
      TRANSPORT_CORE_QUEUE: ${TRANSPORT_CORE_QUEUE}
      TRANSPORT_EVENTS_QUEUE: ${TRANSPORT_EVENTS_QUEUE}
      TRANSPORT_SUBMISSION_QUEUE: ${TRANSPORT_SUBMISSION_QUEUE}
      TRANSPORT_NOTIFICATION_QUEUE: ${TRANSPORT_NOTIFICATION_QUEUE}

    networks:
      - platform-network
      - layer1_traefik-ingress
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.image-generation-frontend.rule=Host(`image-generation.${ENVIRONMENT_SUBDOMAIN}.${HOSTNAME}`)"
        - "traefik.http.routers.image-generation-frontend.entrypoints=websecure"
        - "traefik.http.routers.image-generation-frontend.tls.certresolver=lets-encrypt-tls"
        - "traefik.http.services.image-generation-frontend.loadbalancer.server.port=3000"

  # Microservices
  notification-service:
    image: asaxplayinghorse/notification-service:${IMAGE_TAG}
    environment:
      # Redis/Cache Configuration
      REDIS_HOST: platform-redis
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_PREFIX: ${REDIS_PREFIX}
      REDIS_SECURE: ${REDIS_SECURE}
      # Transport/Message Queue
      TRANSPORT_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      CELERY_BROKER: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      CELERY_QUEUE: ${CELERY_QUEUE}

      TRANSPORT_NOTIFICATION_QUEUE: ${TRANSPORT_NOTIFICATION_QUEUE}
      TRANSPORT_MATCHMAKING_QUEUE: ${TRANSPORT_MATCHMAKING_QUEUE}
      TRANSPORT_ANALYTICS_QUEUE: ${TRANSPORT_ANALYTICS_QUEUE}
      TRANSPORT_IMAGE_GENERATION_QUEUE: ${TRANSPORT_IMAGE_GENERATION_QUEUE}
      TRANSPORT_BOT_QUEUE: ${TRANSPORT_BOT_QUEUE}
      TRANSPORT_CORE_QUEUE: ${TRANSPORT_CORE_QUEUE}
      TRANSPORT_EVENTS_QUEUE: ${TRANSPORT_EVENTS_QUEUE}
      TRANSPORT_SUBMISSION_QUEUE: ${TRANSPORT_SUBMISSION_QUEUE}

    networks:
      - platform-network
    deploy:
      labels:
        - "traefik.enable=false"

  image-generation-service:
    image: asaxplayinghorse/image-generation-service:${IMAGE_TAG}
    environment:
      # Database Configuration
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE: ${DB_DATABASE}
      # MinIO Object Storage
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_PORT: ${MINIO_PORT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_USE_SSL: ${MINIO_USE_SSL}
      MINIO_IMAGE_GENERATION_BUCKET: ${MINIO_IMAGE_GENERATION_BUCKET}
      # Transport/Message Queue
      TRANSPORT_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      CELERY_BROKER: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      CELERY_QUEUE: ${CELERY_QUEUE}

      TRANSPORT_IMAGE_GENERATION_QUEUE: ${TRANSPORT_IMAGE_GENERATION_QUEUE}
      TRANSPORT_MATCHMAKING_QUEUE: ${TRANSPORT_MATCHMAKING_QUEUE}
      TRANSPORT_ANALYTICS_QUEUE: ${TRANSPORT_ANALYTICS_QUEUE}
      TRANSPORT_BOT_QUEUE: ${TRANSPORT_BOT_QUEUE}
      TRANSPORT_CORE_QUEUE: ${TRANSPORT_CORE_QUEUE}
      TRANSPORT_EVENTS_QUEUE: ${TRANSPORT_EVENTS_QUEUE}
      TRANSPORT_SUBMISSION_QUEUE: ${TRANSPORT_SUBMISSION_QUEUE}
      TRANSPORT_NOTIFICATION_QUEUE: ${TRANSPORT_NOTIFICATION_QUEUE}

    networks:
      - platform-network
    deploy:
      labels:
        - "traefik.enable=false"

  server-analytics-service:
    image: asaxplayinghorse/server-analytics-service:${IMAGE_TAG}
    environment:
      # InfluxDB Configuration (keeping existing for now)
      INFLUX_TOKEN: ${INFLUX_TOKEN}
      INFLUX_URL: http://influxdb:8086
      INFLUX_ORG: sprocket
      INFLUX_BUCKET: metrics
      # Transport/Message Queue
      TRANSPORT_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      CELERY_BROKER: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      CELERY_QUEUE: ${CELERY_QUEUE}
      LOGGER_LEVELS: ${LOGGER_LEVELS}
      TRANSPORT_ANALYTICS_QUEUE: ${TRANSPORT_ANALYTICS_QUEUE}
      TRANSPORT_IMAGE_GENERATION_QUEUE: ${TRANSPORT_IMAGE_GENERATION_QUEUE}
      TRANSPORT_MATCHMAKING_QUEUE: ${TRANSPORT_MATCHMAKING_QUEUE}
      TRANSPORT_BOT_QUEUE: ${TRANSPORT_BOT_QUEUE}
      TRANSPORT_CORE_QUEUE: ${TRANSPORT_CORE_QUEUE}
      TRANSPORT_EVENTS_QUEUE: ${TRANSPORT_EVENTS_QUEUE}
      TRANSPORT_SUBMISSION_QUEUE: ${TRANSPORT_SUBMISSION_QUEUE}
      TRANSPORT_NOTIFICATION_QUEUE: ${TRANSPORT_NOTIFICATION_QUEUE}
    networks:
      - platform-network
      - layer2_monitoring-network
    deploy:
      labels:
        - "traefik.enable=false"

  matchmaking-service:
    image: asaxplayinghorse/matchmaking-service:${IMAGE_TAG}
    environment:
      # Redis/Cache Configuration
      REDIS_HOST: platform-redis
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_PREFIX: ${REDIS_PREFIX}
      REDIS_SECURE: ${REDIS_SECURE}
      # Transport/Message Queue
      TRANSPORT_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      CELERY_BROKER: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      CELERY_QUEUE: ${CELERY_QUEUE}

      TRANSPORT_MATCHMAKING_QUEUE: ${TRANSPORT_MATCHMAKING_QUEUE}
      TRANSPORT_ANALYTICS_QUEUE: ${TRANSPORT_ANALYTICS_QUEUE}
      TRANSPORT_IMAGE_GENERATION_QUEUE: ${TRANSPORT_IMAGE_GENERATION_QUEUE}
      TRANSPORT_BOT_QUEUE: ${TRANSPORT_BOT_QUEUE}
      TRANSPORT_CORE_QUEUE: ${TRANSPORT_CORE_QUEUE}
      TRANSPORT_EVENTS_QUEUE: ${TRANSPORT_EVENTS_QUEUE}
      TRANSPORT_SUBMISSION_QUEUE: ${TRANSPORT_SUBMISSION_QUEUE}
      TRANSPORT_NOTIFICATION_QUEUE: ${TRANSPORT_NOTIFICATION_QUEUE}
    networks:
      - platform-network
    depends_on:
      - rabbitmq
    deploy:
      labels:
        - "traefik.enable=false"

  replay-parse-service:
    image: asaxplayinghorse/replay-parse-service:${IMAGE_TAG}
    environment:
      # MinIO Object Storage
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_PORT: ${MINIO_PORT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_USE_SSL: ${MINIO_USE_SSL}
      MINIO_REPLAYS_BUCKET: ${MINIO_REPLAYS_BUCKET}
      # External API Configuration (keeping existing)
      BALLCHASING_API_TOKEN: ${BALLCHASING_API_TOKEN}
      # Transport/Message Queue  
      TRANSPORT_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      CELERY_BROKER: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      CELERY_QUEUE: ${CELERY_QUEUE}
      TRANSPORT_SUBMISSION_QUEUE: ${TRANSPORT_SUBMISSION_QUEUE}
      TRANSPORT_ANALYTICS_QUEUE: ${TRANSPORT_ANALYTICS_QUEUE}
      TRANSPORT_MATCHMAKING_QUEUE: ${TRANSPORT_MATCHMAKING_QUEUE}
      TRANSPORT_IMAGE_GENERATION_QUEUE: ${TRANSPORT_IMAGE_GENERATION_QUEUE}
      TRANSPORT_BOT_QUEUE: ${TRANSPORT_BOT_QUEUE}
      TRANSPORT_CORE_QUEUE: ${TRANSPORT_CORE_QUEUE}
      TRANSPORT_EVENTS_QUEUE: ${TRANSPORT_EVENTS_QUEUE}
      TRANSPORT_NOTIFICATION_QUEUE: ${TRANSPORT_NOTIFICATION_QUEUE}

    networks:
      - platform-network
    deploy:
      labels:
        - "traefik.enable=false"

  elo-service:
    image: asaxplayinghorse/elo-service:${IMAGE_TAG}
    environment:
      # Redis/Cache Configuration
      REDIS_HOST: platform-redis
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_PREFIX: ${REDIS_PREFIX}
      REDIS_SECURE: ${REDIS_SECURE}
      # Transport/Message Queue
      TRANSPORT_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      CELERY_BROKER: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
    networks:
      - platform-network
      - layer1_traefik-ingress
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.elo-service.rule=Host(`elo.${ENVIRONMENT_SUBDOMAIN}.${HOSTNAME}`)"
        - "traefik.http.routers.elo-service.entrypoints=websecure"
        - "traefik.http.routers.elo-service.tls.certresolver=lets-encrypt-tls"
        - "traefik.http.services.elo-service.loadbalancer.server.port=3000"

  submission-service:
    image: asaxplayinghorse/submission-service:${IMAGE_TAG}
    environment:
      # Redis/Cache Configuration
      REDIS_HOST: platform-redis
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_PREFIX: ${REDIS_PREFIX}
      REDIS_SECURE: ${REDIS_SECURE}
      # MinIO Object Storage
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_PORT: ${MINIO_PORT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_USE_SSL: ${MINIO_USE_SSL}
      MINIO_REPLAYS_BUCKET: ${MINIO_REPLAYS_BUCKET}
      # Transport/Message Queue
      TRANSPORT_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      CELERY_BROKER: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      CELERY_QUEUE: ${CELERY_QUEUE}
      TRANSPORT_MATCHMAKING_QUEUE: ${TRANSPORT_MATCHMAKING_QUEUE}
      TRANSPORT_ANALYTICS_QUEUE: ${TRANSPORT_ANALYTICS_QUEUE}
      TRANSPORT_IMAGE_GENERATION_QUEUE: ${TRANSPORT_IMAGE_GENERATION_QUEUE}
      TRANSPORT_BOT_QUEUE: ${TRANSPORT_BOT_QUEUE}
      TRANSPORT_CORE_QUEUE: ${TRANSPORT_CORE_QUEUE}
      TRANSPORT_EVENTS_QUEUE: ${TRANSPORT_EVENTS_QUEUE}
      TRANSPORT_SUBMISSION_QUEUE: ${TRANSPORT_SUBMISSION_QUEUE}
      TRANSPORT_NOTIFICATION_QUEUE: ${TRANSPORT_NOTIFICATION_QUEUE}

    networks:
      - platform-network
    deploy:
      labels:
       - "traefik.enable=false"
