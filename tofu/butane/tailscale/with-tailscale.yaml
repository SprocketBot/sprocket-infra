variant: flatcar
version: 1.0.0

systemd:
  units:
    - name: "prepare-tailscale.service"
      enabled: true
      contents: |
        [Unit]
        Description=Downloads and "ups" the tailscale daemon
        After=network-online.target
        Requires=network-online.target

        [Service]
        Type=oneshot
        Restart=on-failure
        RemainAfterExit=yes
        ExecStart=/etc/assets/prepare-tailscale.sh

        [Install]
        WantedBy=multi-user.target
    
    - name: "tailscaled.service"
      enabled: false
      contents: |
        [Unit]
        Description=Tailscale node agent
        Documentation=https://tailscale.com/kb/
        Wants=network-online.target
        After=network-online.target NetworkManager.service systemd-resolved.service

        [Service]
        ExecStartPre=/opt/bin/tailscaled --cleanup
        ExecStart=/opt/bin/tailscaled --state=/opt/tailscale/tailscaled.state --socket=/run/tailscale/tailscaled.sock --port=46461
        ExecStopPost=/opt/bin/tailscaled --cleanup

        Restart=on-failure
        RestartSec=2

        RuntimeDirectory=tailscale
        RuntimeDirectoryMode=0755
        StateDirectory=tailscale
        StateDirectoryMode=0700
        CacheDirectory=tailscale
        CacheDirectoryMode=0750
        Type=notify

        [Install]
        WantedBy=multi-user.target

storage:
  directories:
    - path: /etc/assets
    - path: /opt/tailscale
  files:
    - path: /etc/assets/tailscale_1.50.1_amd64.tgz
      mode: 0644
      overwrite: true
      contents:
        source: https://pkgs.tailscale.com/stable/tailscale_1.50.1_amd64.tgz
    
    - path: /etc/assets/tailscale-authkey
      mode: 0600
      overwrite: true
      contents: 
        inline: "${tailscale-authkey}"

    - path: /etc/assets/prepare-tailscale.sh
      mode: 0700
      overwrite: true
      contents:
        inline: |
          #!/usr/bin/env bash
          set -e
            tar -xf /etc/assets/tailscale_1.50.1_amd64.tgz -C /opt/bin --strip-components 1 --wildcards "**/tailscale" "**/tailscaled"
            systemctl enable --now tailscaled
            /opt/bin/tailscale up --auth-key $(cat /etc/assets/tailscale-authkey)
            rm /etc/assets/tailscale-authkey
