{
  "version": 4,
  "terraform_version": "1.6.0",
  "serial": 664,
  "lineage": "e06fba94-1c60-de50-92e0-bd078b0ebf5b",
  "outputs": {},
  "resources": [
    {
      "mode": "data",
      "type": "ct_config",
      "name": "ignition",
      "provider": "provider[\"registry.opentofu.org/poseidon/ct\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "content": "# Basic configuration for all sprocket nodes\nvariant: flatcar\nversion: 1.0.0\n\n# TODO: Setup Tailscale\nstorage:\n  files:\n    - path: /etc/hostname\n      mode: 0644\n      overwrite: true\n      contents:\n        inline: sprocket-proxy\n\npasswd:\n  users:\n    - name: sprunkle\n      password_hash: $6$rounds=4096$kzoGtmJp0p/h443e$YVzWkmBO0/4g4nXAtNhDLIWdgT5GNPlQR1YkZ1LFb77cP13L1oCigNONC7VkZCcerXSBGjQaMTSa.pc55bTwt1\n      no_create_home: true\n      shell: /bin/bash\n      groups: [sudo, docker, systemd-journal]",
            "id": "1467941836",
            "pretty_print": true,
            "rendered": "{\n  \"ignition\": {\n    \"config\": {\n      \"replace\": {\n        \"verification\": {}\n      }\n    },\n    \"proxy\": {},\n    \"security\": {\n      \"tls\": {}\n    },\n    \"timeouts\": {},\n    \"version\": \"3.4.0\"\n  },\n  \"kernelArguments\": {},\n  \"passwd\": {\n    \"users\": [\n      {\n        \"groups\": [\n          \"sudo\",\n          \"docker\",\n          \"systemd-journal\"\n        ],\n        \"name\": \"sprunkle\",\n        \"noCreateHome\": true,\n        \"passwordHash\": \"$6$rounds=4096$kzoGtmJp0p/h443e$YVzWkmBO0/4g4nXAtNhDLIWdgT5GNPlQR1YkZ1LFb77cP13L1oCigNONC7VkZCcerXSBGjQaMTSa.pc55bTwt1\",\n        \"shell\": \"/bin/bash\"\n      }\n    ]\n  },\n  \"storage\": {\n    \"directories\": [\n      {\n        \"group\": {},\n        \"path\": \"/opt/vault.d\",\n        \"user\": {}\n      },\n      {\n        \"group\": {},\n        \"path\": \"/etc/vault.d/scripts\",\n        \"user\": {}\n      },\n      {\n        \"group\": {},\n        \"path\": \"/etc/vault.d/policies\",\n        \"user\": {}\n      },\n      {\n        \"group\": {},\n        \"path\": \"/opt/vault\",\n        \"user\": {}\n      },\n      {\n        \"group\": {},\n        \"path\": \"/etc/assets\",\n        \"user\": {}\n      },\n      {\n        \"group\": {},\n        \"path\": \"/opt/consul\",\n        \"user\": {}\n      },\n      {\n        \"group\": {},\n        \"path\": \"/opt/traefik\",\n        \"user\": {}\n      },\n      {\n        \"group\": {},\n        \"path\": \"/opt/traefik/acme\",\n        \"user\": {}\n      },\n      {\n        \"group\": {},\n        \"path\": \"/opt/traefik/logs\",\n        \"user\": {}\n      },\n      {\n        \"group\": {},\n        \"path\": \"/opt/nomad\",\n        \"user\": {}\n      },\n      {\n        \"group\": {},\n        \"path\": \"/opt/tailscale\",\n        \"user\": {}\n      }\n    ],\n    \"disks\": [\n      {\n        \"device\": \"/dev/disk/by-label/tofu_public_opt\",\n        \"partitions\": [\n          {\n            \"label\": \"spr-fc-persist\",\n            \"number\": 1,\n            \"resize\": true,\n            \"wipePartitionEntry\": true\n          }\n        ]\n      }\n    ],\n    \"files\": [\n      {\n        \"group\": {},\n        \"overwrite\": true,\n        \"path\": \"/etc/hostname\",\n        \"user\": {},\n        \"contents\": {\n          \"compression\": \"\",\n          \"source\": \"data:,sprocket-proxy\",\n          \"verification\": {}\n        },\n        \"mode\": 420\n      },\n      {\n        \"group\": {},\n        \"path\": \"/etc/vault.d/vault.hcl\",\n        \"user\": {},\n        \"contents\": {\n          \"compression\": \"gzip\",\n          \"source\": \"data:;base64,H4sIAAAAAAAC/7SQT2syMRDG7/sphnh5XyhxV/pHhD301BZ69LigMTu6wZAsMxOlqN+9ZO1eehBK6XWeyW+e/JKDGoQSFgUjHZzFFeHOsZARFwMoGwMnr+BUAACYtiVkhhpUNXvSpS51tZg/lKUa4hEhZjfsCBncur3GYDYe63znbpx1Ir2mmASJ9cEkL5qSx/o1svxbXwfck452j6JbPKz/33qLQeijjy4I10fcMNpEqIpLUbBEMjv84Vd6I13OBvrA8Y4FAxIosf1ImcDSOM/WePxOPZ3gBeXZ+7cgSFtjkeEMLlifWoRGBZRjpH2joFFVWerH+1xiWpWNgjMYEYJGffEaBZfLYj4b201geVUBR+c9dCa0HiFr4SEXz6vWcbYONVQ36r9Ha3wXWW5I+c1Z07tVpmZkXlxMp38l5jMAAP//yl0SQ8wCAAA=\",\n          \"verification\": {}\n        },\n        \"mode\": 420\n      },\n      {\n        \"group\": {},\n        \"overwrite\": true,\n        \"path\": \"/etc/assets/vault_1.15.0_linux_amd64.zip\",\n        \"user\": {},\n        \"contents\": {\n          \"source\": \"https://releases.hashicorp.com/vault/1.15.0/vault_1.15.0_linux_amd64.zip\",\n          \"verification\": {}\n        },\n        \"mode\": 420\n      },\n      {\n        \"group\": {},\n        \"path\": \"/etc/vault.d/policies/nomad.hcl\",\n        \"user\": {},\n        \"contents\": {\n          \"compression\": \"gzip\",\n          \"source\": \"data:;base64,H4sIAAAAAAAC/5SUwW7bMAyG734Kwr4Na/0EO/S4S1dgxS7DsNISXQtRRE2U3AXD3n2g7STOkATpLY74k99v/nIDD97zG5hEmF14hcwbCgIlWEpQB96irec/IbGne3geaPUMAbdUNSADF2+hIyjRYiYLrj/InUDgDEXI3lcR8wA1ljy0U5t2Gk3tUvsHDEbsnHfZkcAn+F7PHesf8Leq9ryeeaO4Jd4KeUSsmvdDahu5wpgI7UXCfKCJKEIWMsOjttIfI3qnMNCs6gYUfaoaiIkjpZOBas+JAsfEo7NkodtN4tpSj8XnGiJ7Z3ZnjChWiXdCvn+/ERcMb1cpWePngXYw4EgQKW2diOO5Ao0hkWplT+ZiTASJfhUSTd7RFQe/mw5cmlZUNfCCivKzBHVCITuj63vRaqGsU3r0Qhf93pyrROPs9gCKeZ+cwOA5vFIC+u0kL8ATmRyE6nOW9pzAki4ZZSPnMqUSupvfD6ebGc1AZmYc6FTBPXBJwG9hhji+07LEbr2uPSqUyAEkY8ol3sMjT8dO9juQ5bqcLLYjg0WmPvBNMwcPT5+rRmchPH35+rz4lZ20a8bLyTtn9cSN8ncamUBv5y+pntw2YNZazNihkH6D7HK9P1y/Fv8JJWN25u52/dJgM7Zbyqh92vMK7ySvJm7GdiqeZrRXhnyEo/RfAAAA//8qNvSB3gUAAA==\",\n          \"verification\": {}\n        },\n        \"mode\": 384\n      },\n      {\n        \"group\": {},\n        \"path\": \"/etc/vault.d/policies/terraform.hcl\",\n        \"user\": {},\n        \"contents\": {\n          \"compression\": \"gzip\",\n          \"source\": \"data:;base64,H4sIAAAAAAAC/7SUQYvUQBCF7/MrHp2LihLYoyCyzCAszLIeBA/ioSZdOymmp7vpro7Ksv9dEhM2O4wySjwlNPT3Xr0uXoUPxTlQ03DO0IBDB/IWlpR2lBmZm8QK9nvxnFeRtIU5dFf1K4MHNBRpJ05UOOMdvpgmMSmb1zCJyfbfEu14Ytnxrz8nWc1XPI64SWxJJhVtF+Ghwqe7zd1b3GRoKxme2bJ9v1pVWA+kIbBb8rTny+LLP3J9DMVrPutvcnUy0dOt+tBdLZfUc+6SbzAjT4H8V/gy3mf8xIOCwcMfoE+wCX8KfZztynZz/RG3rG2wM6FhW52leG4AXDhBLjYY9CNUWAd/L/uSGNqOosffip7PDX8THJ4/TI/+x91e3NWqwuckyrhebxGDk6ZHvYiJ7+U7W3wTbRGLK0d50zdgTNyxV8gxphA5jeX4cmZ1otTUuHq8upzbrWQFdSSOdm6qkDx1SG8xsSbhjkdrIeFmc1G3jC4GpZ8BAAD//8fdIfH7BQAA\",\n          \"verification\": {}\n        },\n        \"mode\": 384\n      },\n      {\n        \"group\": {},\n        \"path\": \"/etc/vault.d/scripts/initialize-vault.sh\",\n        \"user\": {},\n        \"contents\": {\n          \"compression\": \"gzip\",\n          \"source\": \"data:;base64,H4sIAAAAAAAC/5TQwW4TMRAG4Luf4seN1Paw65ATShWkSlEv9BSaXhCK3N3Z2qxrG89saGj77mgXBEFISL3Z45lvxnPyxgxczJ2PhuIed5adYhJUpNQJ1tT5SBBH2G6ukbrpeGuHIGAqeyqKHnMqgtvL7fXN7nK93qy0E8lLY0JqbHCJZfluMZ/r0bsaYiM+RUhC46jp4btfnGf46MXb4L9Tqzzv9mN8NwbPzvGkML3vWKwMvJqdNUMJqBh69qe32b81fGDjyAZxGs/48hVVQX1EnyvgE/TsSNNYQUsZSOOzelG+w1/tL8ZfRwVQ4xL073ltKGTbw/HcNT72Pmcf7+u61mPJoxfMVecvlDIpy7TpiUbKVKykMtWj6ulQsbOFeLWY/7yKK8QuhXa1wHsYechmzK1Y2jSIeuhbX1BlTPCE1q1qrPyTimfcF8rQ28hkAz7QYVyO/dajuoJeQuP0KRcfBbPFy+nY7Ig0w1TF/6c3KQluUk/xNXRJSdSPAAAA//91R6ZYhQIAAA==\",\n          \"verification\": {}\n        },\n        \"mode\": 448\n      },\n      {\n        \"group\": {},\n        \"path\": \"/etc/vault.d/scripts/unseal-vault.sh\",\n        \"user\": {},\n        \"contents\": {\n          \"compression\": \"gzip\",\n          \"source\": \"data:;base64,H4sIAAAAAAAC/3ySQW8TMRCF7/4VDyeHViLZwAml5FARVULqKZBeEIqczSw2cdeLZzZtBPx3ZO8moSklp9ie9+Z7Mzt4VbQci7WrC6p3WBu2ikkwIqUGmFPlaoJYwnJxi1Dlv3em9QKmuKOo6LEJUXB3vbz9vLqezxczbUWaaVH4UBpvA8v03dvJRCe/m7YuxYUaElBaKrdwVW/nGEzG00Y5Xu3S1ao7X1zipwLQP69YjLQ8G16UbfQYMfTw1LzYvSl4z4Ul48Vq/ML3HxhFjDvxZTb6Aj18YqYxg5bYksZX9TuBLshs0NapClvaM6oY7nP4ynlSD9Z5wsebTzPEVDmKffFqS/srbELu4yqcZblKFnV+TL/BefbX4HBo6+RYR6UN0Mt87+pvverBiU1wUwxPzfVRVIRG8l4zAEJD0Ug4gEI/E5Fn+hea8Snjvhf2kPT4jO9FwfgElWSY5GPl1CbUhPcdaaYcb4pOxGkJH/IXkobe+aDbFkwlFGG8P2QxInTfCKv/TvyMksV5f3B+0XKs1XEufxtYw1gT1eC2LIm5ar1/krhy6k8AAAD//9chkl9cAwAA\",\n          \"verification\": {}\n        },\n        \"mode\": 448\n      },\n      {\n        \"group\": {},\n        \"path\": \"/etc/vault.d/scripts/base-configuration.sh\",\n        \"user\": {},\n        \"contents\": {\n          \"compression\": \"gzip\",\n          \"source\": \"data:;base64,H4sIAAAAAAAC/3xTzW7bPBC86ykmivElOSjMD/C1SKACQZNTi7YokvZo0OLaJEyTLLnyD5q+eyHRUR036cmwdmd2Zjl7eCDaFMXEOEFuiYlMukjEqKgoDvE9GiZ88dY0hlJB6+Aj49vNw8f78c3t7de61MzhSgjrG2m1T3z19uLsrHzeef/5w92nenTcSIbwgcVStpZPlYje80nRf+oE9J8RumkbrPrRTDHKqY8LCOJmAIatIjHUT3Vj/8nk/EKqV1j6Ws8weJZgPyeH/xC9JUx9zAzF/pDMLmTLWvQQ0QG2nIjkaCUnlmqOLWXOcaBovKrPFXwMWrpcc3JBdUblNlqHTh+PF3I9Zrb12QLSWr8iNX6SXm9FsW8bnd1lM2r7S25ZmCkOMIsUUP1AufMmJcqXIeU1WJMrgN7kuBdUj473vOcVNZEkE6psBlVe+9ZKNWwAVefh8vJ/jWq7gTcXGpUyKVi5qf74r9ImMS3wmEXnKY/Q1PE5nOMRcjXH0c8QjWOMLn4dnRQANdo/s1ePdtSXePfafsgmGvC3RsF5xowcRTkEp+e4hncEaSNJtQGtTeJUFlNTdLm5c73LNlEMMiV0icBENnNyaj80fY0yoAqSdc1TVIpSE01g411dPiRSUG00boYQ/dIk4133h31Owc5tyKahlLoKa8pPVqKyJrFxs6qDTow1vKm1UYrcoPHlLOcoT0XXlQT7aYuueeWjejri3SsaZFRPXScY4jkUi0O8tyQd2u5BsZBzQmojwTBMckeMXqalYv/W/+YvfgcAAP//12KqMrUEAAA=\",\n          \"verification\": {}\n        },\n        \"mode\": 448\n      },\n      {\n        \"group\": {},\n        \"path\": \"/etc/vault.d/terraform-password\",\n        \"user\": {},\n        \"contents\": {\n          \"compression\": \"\",\n          \"source\": \"data:,Cs%3FN6q.peex4w-8Y9RX1rW6U9dY%3Dp-tMMdI9!%5DbAhL%3FzuKC%3FRf%25)UHcgrb1faEs%3D\",\n          \"verification\": {}\n        },\n        \"mode\": 256\n      },\n      {\n        \"group\": {},\n        \"path\": \"/etc/consul.d/consul.hcl\",\n        \"user\": {},\n        \"contents\": {\n          \"compression\": \"gzip\",\n          \"source\": \"data:;base64,H4sIAAAAAAAC/2SPy2rrMBCG9/MUw5yzrSOHNu3Gi65K38FgZGkSTMRISONecPzuRU5JF9FO3/DfvFXrWJQzdkgl5ejOrARQD4OfNryLSXcuSpkDAYyT+MF6v52WBd9YX0N4rx5H67jgBSdxYfaMPQnrZ8znnrCn1pjm8NiYxuxa0xNe0Kpm7KmacSk94boSgAsTi94i2v1z1TQtAczT4KIcpxMugMhix8AeO9Q8M6wAhfPHNmUDMMaoRbNN92Tgr8ROscMW4B+yuPyd6pf+43Ld+vALVwKEFLOWLfX6vBTs8OVgzA2dcnKVPZl97eKiSE3409z1/QkAAP//zw6RwX4BAAA=\",\n          \"verification\": {}\n        },\n        \"mode\": 420\n      },\n      {\n        \"group\": {},\n        \"overwrite\": true,\n        \"path\": \"/etc/assets/consul_1.16.2_linux_amd64.zip\",\n        \"user\": {},\n        \"contents\": {\n          \"source\": \"https://releases.hashicorp.com/consul/1.16.2/consul_1.16.2_linux_amd64.zip\",\n          \"verification\": {}\n        },\n        \"mode\": 420\n      },\n      {\n        \"group\": {},\n        \"path\": \"/etc/traefik.yaml\",\n        \"user\": {},\n        \"contents\": {\n          \"compression\": \"gzip\",\n          \"source\": \"data:;base64,H4sIAAAAAAAC/3yTT2/bMAzF7/oURHPoYaiTrh1W+NSuRYEBw1psxe6MxNhcZckQmWTBsO8+yP/irsVyiU09P/3ER1HQdHiMHFRKA7Cndf4DQOcSiZRwWl6tTrtSrdr2iwCJHCeyyjHIWAM4mh1rABrL7Ctkt4lmdbE1NVR2vtLv3WteEVxeXrxGUD/b2VLSbyTR7yiV4EnljIJNh1aNAVBkLxb9W86XF6ewgKeHu4cS7rnaJoK4VajjHjRCRQpa09EBuAUMDtYcXBZojVrMDjX7LeAGzkHqqCCUdmwJ3oGQg4arWmFNnTOhMInCHg/GtCnu2FHqTrbhETg/Bcy9WpLapSakDT8X7hCwYVscsPGdbo9q6xI26IXyuW0MsvW3qOhj1VtRcO3LgKZunL//WKyKVXFeXn1YrcxbMfUWv9oo5D4d7miDW6/jhjMCTdv+3cYQyOrNHhMN5YnrJdAU5hmcvCQ5MQAmB8wbtqgkY9DdJ/Osh3htQ6MZNci+BHQNh2tpU7TPpEVVDcuiMWGV+xpbHfu6zAZLT8VPieE4bLc1ek8hq3//MTne+dZnrr8IixnAYo5gY1C0eh0iN+vEGAobm0n0X5DsPcL0chdmOFMVYJyfEhxXnGO3hMEYM02431LQOzPMg6cd+RI+f71/MAatJZEv/UoeuUfU+h8iHytZ9sLCx8oYbDnLHUq9jpjclD2H4TIPqecrQEmeEgZpY+qyGjXfn7n9QYk3h0H9NwAA//+H+J2qlgQAAA==\",\n          \"verification\": {}\n        },\n        \"mode\": 420\n      },\n      {\n        \"group\": {},\n        \"path\": \"/etc/traefik.dynamic.yaml\",\n        \"user\": {},\n        \"contents\": {\n          \"compression\": \"gzip\",\n          \"source\": \"data:;base64,H4sIAAAAAAAC/7ySsWrDQAyGdz+FxnaIE0oayk2hU+eupZDrWSFH1JORdC55+xL7GlO4LWBPgk/+9cH9J7PeNQDC2VD0OgIMPpNNI4BkQgdvrPZwGEGrvbQczmhth8PhsexhMrn0HJOpgw/4wS/FkAXhsywY6V8mQECxd1SmAcUBoekKU5BLb2VFUYYY0E0y+2MkHEngpJlqchNZ2G46Ousl/vZdzW4EC8uNN2c3E4/HeK7ZFbSwn+/jPiZDSZ4agOaGaj0k9t2rJ58Cynzs+sOtt9O3gizkYGz2ek0cPJ1Yzb08bTaVCt2f+1xy/7393bHb3XbX/AYAAP//EjVr858DAAA=\",\n          \"verification\": {}\n        },\n        \"mode\": 420\n      },\n      {\n        \"group\": {},\n        \"path\": \"/etc/nomad.d/nomad.hcl\",\n        \"user\": {},\n        \"contents\": {\n          \"compression\": \"gzip\",\n          \"source\": \"data:;base64,H4sIAAAAAAAC/7SST4vbMBDF7/oUD20P7aGxU9pSAmEplP457aVHg1GkSSKiSGY0SgrZfPci26ULTfe29kmaeT89Pc0dvvpdYUIqgn06QxKcz2YTCGyEEPzRi487bDkdIWxo6w94ff9GKWfE9M4z1tBNGqSJ6WicVhsfXW+cGwvtYvy1UsadiMVnwkUBwB1+Gh+yNYHG9V5kqIrLBd9IPofwIwrx1ljKeISPNhRH6HQkOSc+dBqdXrbt4uP7ekCzbDuNRxgRRqfr8ZRzp3G96hHPg31BeibevhD+qpTKxCfiOTiK9Xkc1hAuU3ablCQLm6GnXwNZwRrLKrTBU5R/dFsTMtX6yZQgf9/j4cvDCt/TGS7hTNiRQPYESQeKyCQow/3cO+2t8eoyMt6O6+v//FkmI9TXGeo5BapRzdNSy/OF626dglXThGRN2Kcsq0/v2nYMwaaYS5jNPqv4MCuKv53YZOkprn7F94XDH2JeNc3UssgDL5I9kCwcnSbD00WfpnebMHbcBlzV7wAAAP//Cv5eZ3wDAAA=\",\n          \"verification\": {}\n        },\n        \"mode\": 384\n      },\n      {\n        \"group\": {},\n        \"overwrite\": true,\n        \"path\": \"/etc/assets/nomad_1.6.2_linux_amd64.zip\",\n        \"user\": {},\n        \"contents\": {\n          \"source\": \"https://releases.hashicorp.com/nomad/1.6.2/nomad_1.6.2_linux_amd64.zip\",\n          \"verification\": {}\n        },\n        \"mode\": 420\n      },\n      {\n        \"group\": {},\n        \"overwrite\": false,\n        \"path\": \"/etc/nomad.d/nomad.env\",\n        \"user\": {},\n        \"contents\": {\n          \"compression\": \"\",\n          \"source\": \"data:,\",\n          \"verification\": {}\n        },\n        \"mode\": 384\n      },\n      {\n        \"group\": {},\n        \"overwrite\": true,\n        \"path\": \"/etc/assets/tailscale_1.50.1_amd64.tgz\",\n        \"user\": {},\n        \"contents\": {\n          \"source\": \"https://pkgs.tailscale.com/stable/tailscale_1.50.1_amd64.tgz\",\n          \"verification\": {}\n        },\n        \"mode\": 420\n      },\n      {\n        \"group\": {},\n        \"overwrite\": true,\n        \"path\": \"/etc/assets/tailscale-authkey\",\n        \"user\": {},\n        \"contents\": {\n          \"compression\": \"\",\n          \"source\": \"data:,tskey-auth-kMbxHC5CNTRL-bFZDhMRjAEg3r9tacS2kEgTzGtNQXbXG\",\n          \"verification\": {}\n        },\n        \"mode\": 384\n      },\n      {\n        \"group\": {},\n        \"overwrite\": true,\n        \"path\": \"/etc/assets/prepare-tailscale.sh\",\n        \"user\": {},\n        \"contents\": {\n          \"compression\": \"gzip\",\n          \"source\": \"data:;base64,H4sIAAAAAAAC/3yOXUrEQBCE3+cUZfRBFzpjQL2AB1k6k9Yddv6Y7rjG04s+GATxseCrr+r6yq/a/RyLl/KGmfXkVAwkDjDuoPcXeLHgWVVMvXFMGjjJcRof78fpyHl5ehjt9QP0DF+bfclApNZjo1Bzq0WKKSYQXWJaAvdFMRwOu2v4HZfBAbqpSQ6WIIXnJCAq9YIdcviZ26tYG4h4tROdZcPNbWD7+/83dJbtzgE9/8+4zwAAAP//IXiEsycBAAA=\",\n          \"verification\": {}\n        },\n        \"mode\": 448\n      }\n    ],\n    \"filesystems\": [\n      {\n        \"device\": \"/dev/disk/by-partlabel/spr-fc-persist\",\n        \"format\": \"ext4\",\n        \"path\": \"/opt\",\n        \"wipeFilesystem\": false\n      }\n    ]\n  },\n  \"systemd\": {\n    \"units\": [\n      {\n        \"contents\": \"[Unit]\\nDescription=Unpack Vault binary to /opt/bin\\nConditionPathExists=!/opt/bin/vault\\n\\nAfter=network-online.target\\nRequires=network-online.target\\n\\n[Service]\\nType=oneshot\\nRestart=on-failure\\nRemainAfterExit=yes\\nExecStart=/usr/bin/unzip \\\"/etc/assets/vault_1.15.0_linux_amd64.zip\\\" -d /opt/bin\\nExecStart=/usr/bin/rm \\\"/etc/assets/vault_1.15.0_linux_amd64.zip\\\"\\n\\n[Install]\\nWantedBy=multi-user.target\\n\",\n        \"enabled\": true,\n        \"name\": \"prepare-vault-binary.service\"\n      },\n      {\n        \"contents\": \"[Unit]\\nDescription=\\\"HashiCorp Vault - A tool for managing secrets\\\"\\nDocumentation=https://www.vaultproject.io/docs/\\n\\nRequires=network-online.target\\nAfter=network-online.target\\n\\nRequires=consul.service\\nAfter=consul.service\\n\\nRequires=prepare-vault-binary.service\\nAfter=prepare-vault-binary.service\\n\\nConditionFileNotEmpty=/etc/vault.d/vault.hcl\\nStartLimitIntervalSec=60\\nStartLimitBurst=3\\n\\n[Service]\\nType=notify\\nProtectSystem=full\\nProtectHome=read-only\\nPrivateTmp=yes\\nPrivateDevices=yes\\nSecureBits=keep-caps\\nAmbientCapabilities=CAP_IPC_LOCK\\nCapabilityBoundingSet=CAP_SYSLOG CAP_IPC_LOCK\\nNoNewPrivileges=yes\\nExecStart=/opt/bin/vault server -config=/etc/vault.d/vault.hcl\\nExecReload=/bin/kill --signal HUP $MAINPID\\nKillMode=process\\nKillSignal=SIGTERM\\nRestart=on-failure\\nRestartSec=5\\nTimeoutStopSec=30\\nLimitNOFILE=65536\\nLimitMEMLOCK=infinity\\n\\n[Install]\\nWantedBy=multi-user.target\\n\",\n        \"enabled\": true,\n        \"name\": \"vault.service\"\n      },\n      {\n        \"contents\": \"[Unit]\\nDescription=Automatically initialize vault if needed\\n\\nRequires=vault.service\\nAfter=vault.service\\n\\nRequires=prepare-vault-binary.service\\nAfter=prepare-vault-binary.service\\n\\n[Service]\\nType=oneshot\\nRestart=on-failure\\nRemainAfterExit=yes\\nExecStart=/etc/vault.d/scripts/initialize-vault.sh\\n\\n[Install]\\nWantedBy=multi-user.target\\n\",\n        \"enabled\": true,\n        \"name\": \"initialize-vault.service\"\n      },\n      {\n        \"contents\": \"[Unit]\\nDescription=Runs initial config needed for nomad and vault to interact with vault correctly\\n\\nRequires=vault.service\\nAfter=vault.service\\n\\nRequires=prepare-vault-binary.service\\nAfter=prepare-vault-binary.service\\n\\nRequires=initialize-vault.service\\nAfter=initialize-vault.service\\n\\nRequires=unseal-vault.service\\nAfter=unseal-vault.service\\n\\n[Service]\\nExecStart=/etc/vault.d/scripts/base-configuration.sh\\nRemainAfterExit=yes\\nType=oneshot\\nRestart=on-failure\\n\\n[Install]\\nWantedBy=multi-user.target\\n\",\n        \"enabled\": true,\n        \"name\": \"configure-vault.service\"\n      },\n      {\n        \"contents\": \"[Unit]\\nDescription=Periodic check to see if the Vault is sealed\\nAfter=initialize-vault.service\\nConditionPathExists=/opt/vault.d/unseals\\n\\n[Service]\\nType=oneshot\\nExecStart=/etc/vault.d/scripts/unseal-vault.sh\\nRestart=on-failure\\n\\n[Install]\\nWantedBy=multi-user.target\\n\",\n        \"enabled\": true,\n        \"name\": \"unseal-vault.service\"\n      },\n      {\n        \"contents\": \"[Unit]\\nDescription=Timer for periodic Vault unsealing\\n\\n[Timer]\\nOnBootSec=1min\\nOnUnitActiveSec=5min\\nPersistent=true\\n\\n[Install]\\nWantedBy=timers.target\\n\",\n        \"enabled\": true,\n        \"name\": \"unseal-vault.timer\"\n      },\n      {\n        \"contents\": \"[Unit]\\nDescription=Unpack Consul binary to /opt/bin\\nConditionPathExists=!/opt/bin/consul\\nAfter=network-online.target\\nRequires=network-online.targets\\n\\n[Service]\\nType=oneshot\\nRestart=on-failure\\nRemainAfterExit=yes\\nExecStart=/usr/bin/unzip \\\"/etc/assets/consul_1.16.2_linux_amd64.zip\\\" -d /opt/bin\\nExecStart=/usr/bin/rm \\\"/etc/assets/consul_1.16.2_linux_amd64.zip\\\"\\n\\n[Install]\\nWantedBy=multi-user.target\\n\",\n        \"enabled\": true,\n        \"name\": \"prepare-consul-binary.service\"\n      },\n      {\n        \"contents\": \"[Unit]\\nDescription=\\\"HashiCorp Consul - A service mesh solution\\\"\\nDocumentation=https://www.consul.io/docs\\n\\nRequires=network-online.target \\nAfter=network-online.target\\n\\nRequires=prepare-consul-binary.service\\nAfter=prepare-consul-binary.service\\n\\nConditionFileNotEmpty=/etc/consul.d/consul.hcl\\nConditionPathExists=/opt/bin/consul\\n\\n[Service]\\nEnvironmentFile=-/etc/consul.d/consul.env\\nExecStart=/opt/bin/consul agent -config-dir /etc/consul.d/\\nExecReload=/bin/kill --signal HUP $MAINPID\\nKillMode=process\\nKillSignal=SIGTERM\\nRestart=on-failure\\nLimitNOFILE=65536\\n\\n[Install]\\nWantedBy=multi-user.target\\n\",\n        \"enabled\": true,\n        \"name\": \"consul.service\"\n      },\n      {\n        \"contents\": \"[Unit]\\nDescription=Unpack Traefik binary to /opt/bin\\nConditionPathExists=!/opt/bin/traefik\\n\\n[Service]\\nType=oneshot\\nRestart=on-failure\\nRemainAfterExit=yes\\nExecStart=/usr/bin/wget https://github.com/traefik/traefik/releases/download/v3.0.0-beta4/traefik_v3.0.0-beta4_linux_amd64.tar.gz -O /opt/traefik-beta4.tar\\nExecStart=/usr/bin/tar -xf /opt/traefik-beta4.tar -C /opt/bin\\nExecStart=/usr/bin/rm \\\"/opt/traefik-beta4.tar\\\"\\nExecStart=mkdir -p /opt/traefik/acme\\n\\n[Install]\\nWantedBy=multi-user.target\\n\",\n        \"enabled\": true,\n        \"name\": \"prepare-traefik-binary.service\"\n      },\n      {\n        \"contents\": \"[Unit]\\nDescription=\\\"Traefik Reverse Proxy\\\"\\nDocumentation=https://docs.traefik.io/traefik\\nAfter=network-online.target\\nAfter=prepare-vault-binary.service\\n\\n[Service]\\nRestart=always\\nExecStart=/opt/bin/traefik --configfile=/etc/traefik.yaml\\nLimitNOFILE=1048576\\nPrivateTmp=true\\nPrivateDevices=true\\nProtectHome=tmpfs\\nProtectSystem=full\\nReadWriteDirectories=/opt/traefik\\nReadOnlyDirectories=/etc/traefik\\nCapabilityBoundingSet=CAP_NET_BIND_SERVICE\\nAmbientCapabilities=CAP_NET_BIND_SERVICE\\nNoNewPrivileges=true\\n\\n[Install]\\nWantedBy=multi-user.target\\n\",\n        \"enabled\": true,\n        \"name\": \"traefik.service\"\n      },\n      {\n        \"contents\": \"[Unit]\\nDescription=Unpack Nomad binary to /opt/bin\\nConditionPathExists=!/opt/bin/nomad\\n\\n[Service]\\nType=oneshot\\nRestart=on-failure\\nRemainAfterExit=yes\\nEnvironment=NOMAD_VERSION=1.6.2\\nExecStart=/usr/bin/unzip \\\"/etc/assets/nomad_1.6.2_linux_amd64.zip\\\" -d /opt/bin\\nExecStart=/usr/bin/rm \\\"/etc/assets/nomad_1.6.2_linux_amd64.zip\\\"\\n\\n[Install]\\nWantedBy=multi-user.target\\n\",\n        \"enabled\": true,\n        \"name\": \"prepare-nomad-binary.service\"\n      },\n      {\n        \"contents\": \"[Unit]\\nDescription=Nomad\\nDocumentation=https://www.nomadproject.io/docs/\\n\\nWants=network-online.target\\nAfter=network-online.target\\n\\nRequires=prepare-nomad-binary.service\\nAfter=prepare-nomad-binary.service\\n\\nRequires=consul.service\\nAfter=consul.service\\n\\n\\nWants=vault.service\\nAfter=vault.service\\n\\nWants=configure-vault.service\\nAfter=configure-vault.service\\n\\n\\n[Service]\\nEnvironmentFile=/etc/nomad.d/nomad.env\\nExecReload=/bin/kill -HUP $MAINPID\\nExecStart=/opt/bin/nomad agent -config /etc/nomad.d\\nKillMode=process\\nKillSignal=SIGINT\\nLimitNOFILE=65536\\nLimitNPROC=infinity\\nRestart=on-failure\\nRestartSec=2\\nTasksMax=infinity\\nOOMScoreAdjust=-1000\\n\\n[Install]\\nWantedBy=multi-user.target\\n\",\n        \"enabled\": true,\n        \"name\": \"nomad-agent.service\"\n      },\n      {\n        \"contents\": \"[Unit]\\nDescription=Downloads and \\\"ups\\\" the tailscale daemon\\nAfter=network-online.target\\nRequires=network-online.target\\n\\n[Service]\\nType=oneshot\\nRestart=on-failure\\nRemainAfterExit=yes\\nExecStart=/etc/assets/prepare-tailscale.sh\\n\\n[Install]\\nWantedBy=multi-user.target\\n\",\n        \"enabled\": true,\n        \"name\": \"prepare-tailscale.service\"\n      },\n      {\n        \"contents\": \"[Unit]\\nDescription=Tailscale node agent\\nDocumentation=https://tailscale.com/kb/\\nWants=network-online.target\\nAfter=network-online.target NetworkManager.service systemd-resolved.service\\n\\n[Service]\\nExecStartPre=/opt/bin/tailscaled --cleanup\\nExecStart=/opt/bin/tailscaled --state=/opt/tailscale/tailscaled.state --socket=/run/tailscale/tailscaled.sock --port=46461\\nExecStopPost=/opt/bin/tailscaled --cleanup\\n\\nRestart=on-failure\\nRestartSec=2\\n\\nRuntimeDirectory=tailscale\\nRuntimeDirectoryMode=0755\\nStateDirectory=tailscale\\nStateDirectoryMode=0700\\nCacheDirectory=tailscale\\nCacheDirectoryMode=0750\\nType=notify\\n\\n[Install]\\nWantedBy=multi-user.target\\n\",\n        \"enabled\": false,\n        \"name\": \"tailscaled.service\"\n      }\n    ]\n  }\n}",
            "snippets": [
              "variant: flatcar\nversion: 1.0.0\n\nstorage:\n  disks:\n    - device: /dev/disk/by-label/tofu_public_opt\n      partitions:\n        - label: spr-fc-persist\n          wipe_partition_entry: true\n          resize: true\n          number: 1\n  filesystems:\n    - path: /opt\n      device: /dev/disk/by-partlabel/spr-fc-persist\n      format: ext4\n      wipe_filesystem: false\n      with_mount_unit: false",
              "variant: flatcar\nversion: 1.0.0\n\nsystemd:\n  units: \n    - name: \"prepare-vault-binary.service\"\n      enabled: true\n      contents: |\n        [Unit]\n        Description=Unpack Vault binary to /opt/bin\n        ConditionPathExists=!/opt/bin/vault\n        \n        After=network-online.target\n        Requires=network-online.target\n\n        [Service]\n        Type=oneshot\n        Restart=on-failure\n        RemainAfterExit=yes\n        ExecStart=/usr/bin/unzip \"/etc/assets/vault_1.15.0_linux_amd64.zip\" -d /opt/bin\n        ExecStart=/usr/bin/rm \"/etc/assets/vault_1.15.0_linux_amd64.zip\"\n\n        [Install]\n        WantedBy=multi-user.target\n\n    - name: \"vault.service\"\n      enabled: true\n      contents: |\n        [Unit]\n        Description=\"HashiCorp Vault - A tool for managing secrets\"\n        Documentation=https://www.vaultproject.io/docs/\n        \n        Requires=network-online.target\n        After=network-online.target\n\n        Requires=consul.service\n        After=consul.service\n\n        Requires=prepare-vault-binary.service\n        After=prepare-vault-binary.service\n\n        ConditionFileNotEmpty=/etc/vault.d/vault.hcl\n        StartLimitIntervalSec=60\n        StartLimitBurst=3\n\n        [Service]\n        Type=notify\n        ProtectSystem=full\n        ProtectHome=read-only\n        PrivateTmp=yes\n        PrivateDevices=yes\n        SecureBits=keep-caps\n        AmbientCapabilities=CAP_IPC_LOCK\n        CapabilityBoundingSet=CAP_SYSLOG CAP_IPC_LOCK\n        NoNewPrivileges=yes\n        ExecStart=/opt/bin/vault server -config=/etc/vault.d/vault.hcl\n        ExecReload=/bin/kill --signal HUP $MAINPID\n        KillMode=process\n        KillSignal=SIGTERM\n        Restart=on-failure\n        RestartSec=5\n        TimeoutStopSec=30\n        LimitNOFILE=65536\n        LimitMEMLOCK=infinity\n\n        [Install]\n        WantedBy=multi-user.target\n\n    - name: \"initialize-vault.service\"\n      enabled: true\n      contents: |\n        [Unit]\n        Description=Automatically initialize vault if needed\n        \n        Requires=vault.service\n        After=vault.service\n\n        Requires=prepare-vault-binary.service\n        After=prepare-vault-binary.service\n\n        [Service]\n        Type=oneshot\n        Restart=on-failure\n        RemainAfterExit=yes\n        ExecStart=/etc/vault.d/scripts/initialize-vault.sh\n\n        [Install]\n        WantedBy=multi-user.target\n\n    - name: \"configure-vault.service\"\n      enabled: true\n      contents: |\n        [Unit]\n        Description=Runs initial config needed for nomad and vault to interact with vault correctly\n\n        Requires=vault.service\n        After=vault.service\n\n        Requires=prepare-vault-binary.service\n        After=prepare-vault-binary.service\n\n        Requires=initialize-vault.service\n        After=initialize-vault.service\n        \n        Requires=unseal-vault.service\n        After=unseal-vault.service\n\n        [Service]\n        ExecStart=/etc/vault.d/scripts/base-configuration.sh\n        RemainAfterExit=yes\n        Type=oneshot\n        Restart=on-failure\n\n        [Install]\n        WantedBy=multi-user.target\n\n    - name: \"unseal-vault.service\"\n      enabled: true\n      contents: |\n        [Unit]\n        Description=Periodic check to see if the Vault is sealed\n        After=initialize-vault.service\n        ConditionPathExists=/opt/vault.d/unseals\n\n        [Service]\n        Type=oneshot\n        ExecStart=/etc/vault.d/scripts/unseal-vault.sh\n        Restart=on-failure\n\n        [Install]\n        WantedBy=multi-user.target\n\n\n    - name: \"unseal-vault.timer\"\n      enabled: true\n      contents: |\n        [Unit]\n        Description=Timer for periodic Vault unsealing\n\n        [Timer]\n        OnBootSec=1min\n        OnUnitActiveSec=5min\n        Persistent=true\n\n        [Install]\n        WantedBy=timers.target\n\n\nstorage:\n  directories:\n    - path: /opt/vault.d\n    - path: /etc/vault.d/scripts\n    - path: /etc/vault.d/policies\n    - path: /opt/vault\n    - path: /etc/assets\n\n  files:\n    - path: /etc/vault.d/vault.hcl\n      mode: 0644\n      contents:\n        inline: |\n          ui = true\n          \n          service_registration \"consul\" {\n              address = \"127.0.0.1:8500\"\n              service_tags = \"traefik.enable=true,traefik.http.routers.vault.rule=Host(`vault.spr.ocket.dev`),traefik.http.routers.vault.entrypoints=websecure\"\n          }\n          \n          storage \"consul\" {\n              address = \"127.0.0.1:8500\"\n              path = \"vault\"\n          }\n          \n          listener \"tcp\" {\n              # Tailscale\n              address = \"{{ GetAllInterfaces | include \\\"network\\\" \\\"100.64.0.0/10\\\" | attr \\\"address\\\" }}:8200\"\n              # Traefik will handle https\n              tls_disable = 1\n          }\n          \n          listener \"tcp\" {\n              # Localhost\n              address = \"127.0.0.1:8200\"\n              # Traefik will handle https\n              tls_disable = 1\n          }\n          \n          api_addr = \"http://{{ GetAllInterfaces | include \\\"network\\\" \\\"100.64.0.0/10\\\" | attr \\\"address\\\" }}:8200\"\n          \n\n    - path: /etc/assets/vault_1.15.0_linux_amd64.zip\n      mode: 0644\n      overwrite: true\n      contents:\n        source: \"https://releases.hashicorp.com/vault/1.15.0/vault_1.15.0_linux_amd64.zip\"\n\n    - path: /etc/vault.d/policies/nomad.hcl\n      mode: 0600\n      contents:\n        inline: |\n          # Allow creating tokens under \"nomad\" token role. The token role name\n          # should be updated if \"nomad\" is not used.\n          path \"auth/token/create/nomad\" { capabilities = [\"update\"] }\n\n          # Allow looking up \"nomad\" token role. The token role name should be\n          # updated if \"nomad\" is not used.\n          path \"auth/token/roles/nomad\" { capabilities = [\"read\"] }\n\n          # Allow looking up the token passed to Nomad to validate # the token has the\n          # proper capabilities. This is provided by the \"default\" policy.\n          path \"auth/token/lookup-self\" { capabilities = [\"read\"] }\n\n          # Allow looking up incoming tokens to validate they have permissions to access\n          # the tokens they are requesting. This is only required if\n          # `allow_unauthenticated` is set to false.\n          path \"auth/token/lookup\" { capabilities = [\"update\"] }\n\n          # Allow revoking tokens that should no longer exist. This allows revoking\n          # tokens for dead tasks.\n          path \"auth/token/revoke-accessor\" { capabilities = [\"update\"] }\n\n          # Allow checking the capabilities of our own token. This is used to validate the\n          # token upon startup. Note this requires update permissions because the Vault API\n          # is a POST\n          path \"sys/capabilities-self\" { capabilities = [\"update\"] }\n\n          # Allow our own token to be renewed.\n          path \"auth/token/renew-self\" { capabilities = [\"update\"] }\n\n          path \"database/creds/nomad*\" { capabilities = [\"read\"] }\n          path \"database/static-creds/nomad*\" { capabilities = [\"read\"] }\n\n          path \"kv/metadata/*\" { capabilities = [\"list\"] }\n          path \"kv/data/nomad/*\" { capabilities = [\"read\", \"list\"] }\n          \n    - path: /etc/vault.d/policies/terraform.hcl\n      mode: 0600\n      contents:\n        inline: |\n          # Full access to kv and database secret engines\n          path \"kv2/*\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\"] }\n          path \"database/*\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\"] }\n          path \"auth/*\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\"] } # TODO: Is this needed?\n\n          # Create and Manage kv and database secret engines\n          path \"sys/mounts\" { capabilities = [\"read\", \"list\"] }\n          path \"sys/mounts/kv2\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\"] }\n          path \"sys/mounts/kv2/*\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\"] }\n          path \"sys/mounts/database\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\"] }\n          path \"sys/mounts/database/*\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\"] }\n\n          path \"sys/remount\" {capabilities = [\"create\", \"update\", \"read\", \"delete\", \"list\"]}\n\n          # Create LDAP Method\n          path \"sys/auth/ldap\" { capabilities = [ \"create\", \"read\", \"update\", \"delete\", \"sudo\" ] }\n          # Configure the LDAP method\n          path \"sys/auth/ldap/*\" { capabilities = [ \"create\", \"read\", \"update\", \"delete\", \"list\" ] }\n          path \"sys/auth\" { capabilities = [\"read\", \"list\"] }\n          path \"sys/mounts/auth/ldap/*\" { capabilities = [ \"create\", \"read\", \"update\", \"delete\", \"list\" ] }\n\n          # Write ACL policies (prefixed with pulumi- to prevent improper access)\n          path \"sys/policies/acl/pulumi-*\" { capabilities = [ \"create\", \"read\", \"update\", \"delete\", \"list\" ] }\n\n          # List available secrets engines to retrieve accessor ID\n          path \"sys/mounts\" { capabilities = [ \"read\" ] }\n\n      #### Scripts\n    - path: /etc/vault.d/scripts/initialize-vault.sh\n      mode: 0700\n      contents:\n        inline: |\n          #!/usr/bin/env bash\n          set -e\n\n          # Define the URL of the Vault server\n          export VAULT_ADDR=\"http://localhost:8200\"\n\n          # Function to check if Vault is initialized\n          is_vault_init() {\n            init_status=$(curl -s \"$VAULT_ADDR/v1/sys/health\" | jq -r .initialized)\n            [ \"$init_status\" = \"true\" ]\n          }\n          if is_vault_init; then\n            echo \"Vault is already initialized. Skipping...\"\n            exit 0\n          fi;\n          \n          /opt/bin/vault operator init -key-shares=20 -key-threshold=2 \u003e /tmp/init-stdout\n          mkdir -p /opt/vault.d\n          cat /tmp/init-stdout | grep \"Unseal Key\" | awk -F \": \" '{print $2}' \u003e /opt/vault.d/unseals\n          cat /tmp/init-stdout | grep \"Root Token\" | awk -F \": \" '{print $2}' \u003e /opt/vault.d/root\n\n    - path: /etc/vault.d/scripts/unseal-vault.sh\n      mode: 0700\n      contents:\n        inline: |\n          #!/usr/bin/env bash\n          set -e\n\n          # Define the URL of the Vault server\n          export VAULT_ADDR=\"http://localhost:8200\"\n\n          # Function to check if Vault is sealed\n          is_vault_sealed() {\n              sealed_status=$(curl -s \"$VAULT_ADDR/v1/sys/health\" | jq -r .sealed)\n              [ \"$sealed_status\" = \"true\" ]\n          }\n\n          # Read unseal keys from the file\n          while IFS= read -r unseal_key; do\n              if is_vault_sealed; then\n                  # Vault is sealed, so unseal it\n                  echo \"Unsealing Vault with key: $unseal_key\"\n                  /opt/bin/vault operator unseal \"$unseal_key\"\n              else\n                  # Vault is already unsealed, so exit\n                  echo \"Vault is already unsealed.\"\n                  exit 0\n              fi\n          done \u003c /opt/vault.d/unseals\n\n          # Check the sealed status after all unseal attempts\n          if is_vault_sealed; then\n              echo \"Vault is still sealed after all unseal attempts.\"\n          else\n              echo \"Vault has been successfully unsealed.\"\n          fi\n\n    - path: /etc/vault.d/scripts/base-configuration.sh\n      mode: 0700\n      contents:\n        inline: |\n          #!/usr/bin/env bash\n          set -e\n\n          # Write Policies\n          export VAULT_ADDR=\"http://localhost:8200\"\n          export VAULT_TOKEN=$(cat /opt/vault.d/root)\n          /opt/bin/vault policy write terraform /etc/vault.d/policies/terraform.hcl\n          /opt/bin/vault policy write nomad /etc/vault.d/policies/nomad.hcl\n\n          # Write a token \u0026 role for nomad\n\n          /opt/bin/vault write /auth/token/roles/nomad renewable=true token_period=1d orphan=true name=nomad token_explicit_max_ttl=0m allowed_policies=nomad\n\n          touch /etc/nomad.d/nomad.env\n          if ! grep -q \"VAULT_TOKEN\" \"/etc/nomad.d/nomad.env\"; then\n            vault_token=$(/opt/bin/vault token create -orphan -policy=nomad -renewable -ttl=336h -period=72h -display-name=nomad-system | grep token | head -n 1 | awk '{print $2}')\n            echo \"VAULT_TOKEN=$vault_token\" \u003e /etc/nomad.d/nomad.env\n          else\n            echo \"Did not generate nomad token; one already exists\"\n          fi\n\n    \n          # Enable userpass auth backend\n          /opt/bin/vault auth enable -path=tf -description=\"Used during provisioning to allow terraform access to the vault\" -listing-visibility=hidden userpass\n          /opt/bin/vault write auth/tf/users/tofu password=$(cat /etc/vault.d/terraform-password) policies=terraform\n          # Clean up to make sure it isn't visible\n          rm /etc/vault.d/terraform-password\n\n    - path: /etc/vault.d/terraform-password\n      mode: 0400\n      contents: \n        inline: \"Cs?N6q.peex4w-8Y9RX1rW6U9dY=p-tMMdI9!]bAhL?zuKC?Rf%)UHcgrb1faEs=\"",
              "variant: flatcar\nversion: 1.0.0\n\nsystemd:\n  units:\n      # Download the consul binary\n    - name: \"prepare-consul-binary.service\"\n      enabled: true\n      contents: |\n        [Unit]\n        Description=Unpack Consul binary to /opt/bin\n        ConditionPathExists=!/opt/bin/consul\n        After=network-online.target\n        Requires=network-online.targets\n\n        [Service]\n        Type=oneshot\n        Restart=on-failure\n        RemainAfterExit=yes\n        ExecStart=/usr/bin/unzip \"/etc/assets/consul_1.16.2_linux_amd64.zip\" -d /opt/bin\n        ExecStart=/usr/bin/rm \"/etc/assets/consul_1.16.2_linux_amd64.zip\"\n\n        [Install]\n        WantedBy=multi-user.target\n\n      # Run consul\n      # This could be a server or a client because consul uses\n      # the config file to determine that behavior\n    - name: \"consul.service\"\n      enabled: true\n      contents: |\n        [Unit]\n        Description=\"HashiCorp Consul - A service mesh solution\"\n        Documentation=https://www.consul.io/docs\n        \n        Requires=network-online.target \n        After=network-online.target\n        \n        Requires=prepare-consul-binary.service\n        After=prepare-consul-binary.service\n\n        ConditionFileNotEmpty=/etc/consul.d/consul.hcl\n        ConditionPathExists=/opt/bin/consul\n\n        [Service]\n        EnvironmentFile=-/etc/consul.d/consul.env\n        ExecStart=/opt/bin/consul agent -config-dir /etc/consul.d/\n        ExecReload=/bin/kill --signal HUP $MAINPID\n        KillMode=process\n        KillSignal=SIGTERM\n        Restart=on-failure\n        LimitNOFILE=65536\n\n        [Install]\n        WantedBy=multi-user.target\n\nstorage:\n  directories:\n    - path: /etc/assets\n    - path: /opt/consul\n  files:\n      # Consul configuration file\n    - path: /etc/consul.d/consul.hcl\n      mode: 0644\n      contents:\n        inline: |\n          datacenter = \"sprocket\"\n          \n          data_dir = \"/opt/consul\"\n          \n          bind_addr = \"{{ GetAllInterfaces | include \\\"network\\\" \\\"100.64.0.0/10\\\" | attr \\\"address\\\" }}\"\n          \n          client_addr = \"127.0.0.1\"\n          \n          ui_config {\n            enabled = true\n          }\n          \n          server = true\n          \n          bootstrap = true\n          \n          bootstrap_expect = 1\n          \n          # encrypt = \"$ {consul-encrypt}\"\n           \n          ports {\n                  dns = 8600\n                  grpc = 8502\n          }\n          \n          connect {\n                  enabled = true\n          }\n      # Consul Binary Package\n    - path: /etc/assets/consul_1.16.2_linux_amd64.zip\n      overwrite: true\n      mode: 0644\n      contents:\n        source: https://releases.hashicorp.com/consul/1.16.2/consul_1.16.2_linux_amd64.zip",
              "variant: flatcar\nversion: 1.0.0\n\nsystemd:\n  units:\n    # Download the traefik binary\n    - name: \"prepare-traefik-binary.service\"\n      enabled: true\n      contents: |\n        [Unit]\n        Description=Unpack Traefik binary to /opt/bin\n        ConditionPathExists=!/opt/bin/traefik\n\n        [Service]\n        Type=oneshot\n        Restart=on-failure\n        RemainAfterExit=yes\n        ExecStart=/usr/bin/wget https://github.com/traefik/traefik/releases/download/v3.0.0-beta4/traefik_v3.0.0-beta4_linux_amd64.tar.gz -O /opt/traefik-beta4.tar\n        ExecStart=/usr/bin/tar -xf /opt/traefik-beta4.tar -C /opt/bin\n        ExecStart=/usr/bin/rm \"/opt/traefik-beta4.tar\"\n        ExecStart=mkdir -p /opt/traefik/acme\n\n        [Install]\n        WantedBy=multi-user.target\n\n    # Set up the traefik service\n    - name: \"traefik.service\"\n      enabled: true\n      contents: |\n        [Unit]\n        Description=\"Traefik Reverse Proxy\"\n        Documentation=https://docs.traefik.io/traefik\n        After=network-online.target\n        After=prepare-vault-binary.service\n\n        [Service]\n        Restart=always\n        ExecStart=/opt/bin/traefik --configfile=/etc/traefik.yaml\n        LimitNOFILE=1048576\n        PrivateTmp=true\n        PrivateDevices=true\n        ProtectHome=tmpfs\n        ProtectSystem=full\n        ReadWriteDirectories=/opt/traefik\n        ReadOnlyDirectories=/etc/traefik\n        CapabilityBoundingSet=CAP_NET_BIND_SERVICE\n        AmbientCapabilities=CAP_NET_BIND_SERVICE\n        NoNewPrivileges=true\n\n        [Install]\n        WantedBy=multi-user.target\n\nstorage:\n  files:\n    - path: /etc/traefik.yaml\n      mode: 0644\n      contents:\n        inline: |\n          entryPoints:\n            web:\n              address: ':80'\n              http:\n                redirections:\n                  entryPoint:\n                    to: websecure\n                    scheme: https\n            websecure:\n              address: ':443'\n              http:\n                tls:\n                  certResolver: lets-encrypt\n          \n            tailscale:\n              address: ':4443' # TODO: Figure out how to get the tailscale ip and bind to that.\n                               # A 1 shot service + sed might be the easiest way\n          \n          providers:\n            file:\n              filename: /etc/traefik.dynamic.yaml\n              watch: false\n          \n            consulCatalog:\n              endpoint:\n                  address: 127.0.0.1:8500\n                  scheme: http\n              exposedByDefault: false\n              watch: true\n              connectAware: true\n          \n            consul:\n              endpoints:\n                - \"127.0.0.1:8500\"\n            \n          certificatesResolvers:\n            lets-encrypt:\n              acme:\n                email: admin@sprocket.gg\n                storage: /opt/traefik/acme/le.json\n                tlsChallenge: {}\n            # lets-encrypt-dns:\n            #   acme:\n            #     email: contact@noimbrian.com\n            #     storage: /opt/traefik/acme/le-dns.json\n            #     dnsChallenge:\n            #       provider: digitalocean\n          \n          \n          # TODO: FluentD\n          log:\n            level: INFO\n          \n          accessLog:\n            filePath: /opt/traefik/logs/access.log\n          \n          api:\n            dashboard: true\n            insecure: true\n          \n          serversTransport:\n            insecureSkipVerify: true\n          \n\n    - path: /etc/traefik.dynamic.yaml\n      mode: 0644\n      contents:\n        inline: |\n          http:\n            routers:\n              vault:\n                rule: Host(`vault.spr.ocket.dev`)\n                entrypoints: [ websecure ]\n                tls:\n                  certResolver: lets-encrypt\n                service: vault@file\n              consul:\n                rule: Host(`consul.spr.ocket.dev`)\n                entrypoints: [ websecure ]\n                tls:\n                  certResolver: lets-encrypt\n                service: consul@file\n              nomad:\n                rule: Host(`nomad.spr.ocket.dev`)\n                entrypoints: [ websecure ]\n                tls:\n                  certResolver: lets-encrypt\n                service: nomad@file\n              traefik:\n                rule: Host(`traefik.spr.ocket.dev`)\n                entrypoints: [ websecure ]\n                tls:\n                  certResolver: lets-encrypt\n                service: api@internal\n            \n            services:\n              vault:\n                loadBalancer:\n                  servers:\n                    - url: http://localhost:8200\n              consul:\n                loadBalancer:\n                  servers:\n                    - url: http://localhost:8500\n              nomad:\n                loadBalancer:\n                  servers:\n                    - url: http://localhost:4646\n          \n\n  directories:\n    - path: /opt/traefik\n    - path: /opt/traefik/acme\n    - path: /opt/traefik/logs",
              "variant: flatcar\nversion: 1.0.0\n\nsystemd:\n  units:\n    # Download the nomad binary\n    - name: \"prepare-nomad-binary.service\"\n      enabled: true\n      contents: |\n        [Unit]\n        Description=Unpack Nomad binary to /opt/bin\n        ConditionPathExists=!/opt/bin/nomad\n\n        [Service]\n        Type=oneshot\n        Restart=on-failure\n        RemainAfterExit=yes\n        Environment=NOMAD_VERSION=1.6.2\n        ExecStart=/usr/bin/unzip \"/etc/assets/nomad_1.6.2_linux_amd64.zip\" -d /opt/bin\n        ExecStart=/usr/bin/rm \"/etc/assets/nomad_1.6.2_linux_amd64.zip\"\n\n        [Install]\n        WantedBy=multi-user.target\n    # Run the nomad agent\n    - name: \"nomad-agent.service\"\n      enabled: true\n      contents: |\n        [Unit]\n        Description=Nomad\n        Documentation=https://www.nomadproject.io/docs/\n        \n        Wants=network-online.target\n        After=network-online.target\n\n        Requires=prepare-nomad-binary.service\n        After=prepare-nomad-binary.service\n        \n        Requires=consul.service\n        After=consul.service\n\n        \n        Wants=vault.service\n        After=vault.service\n        \n        Wants=configure-vault.service\n        After=configure-vault.service\n        \n\n        [Service]\n        EnvironmentFile=/etc/nomad.d/nomad.env\n        ExecReload=/bin/kill -HUP $MAINPID\n        ExecStart=/opt/bin/nomad agent -config /etc/nomad.d\n        KillMode=process\n        KillSignal=SIGINT\n        LimitNOFILE=65536\n        LimitNPROC=infinity\n        Restart=on-failure\n        RestartSec=2\n        TasksMax=infinity\n        OOMScoreAdjust=-1000\n\n        [Install]\n        WantedBy=multi-user.target\n    \n    \nstorage:\n  files: \n    # Nomad Configuration\n    - path: /etc/nomad.d/nomad.hcl\n      mode: 0600\n      contents:\n        inline: |\n          # Figure out how to disable rate limiting from traefik (?)\n          \n          data_dir = \"/opt/nomad\"\n          bind_addr = \"0.0.0.0\"\n          \n          advertise {\n              # Tailscale\n              http = \"{{ GetAllInterfaces | include \\\"network\\\" \\\"100.64.0.0/10\\\" | attr \\\"address\\\" }}\"\n              rpc = \"{{ GetAllInterfaces | include \\\"network\\\" \\\"100.64.0.0/10\\\" | attr \\\"address\\\" }}\"\n              serf = \"{{ GetAllInterfaces | include \\\"network\\\" \\\"100.64.0.0/10\\\" | attr \\\"address\\\" }}\"\n          }\n          \n          \n          server {\n              enabled = true\n              bootstrap_expect = 1\n          }\n          \n          client {\n              enabled = false\n          }\n          \n          vault {\n              # TODO: How do we get the token set up?\n              # token = ${vault-token}\n              enabled = true\n              create_from_role = \"nomad\"\n              address = \"http://localhost:8200\"\n          }\n          \n          consul {\n              address = \"http://localhost:8500\"\n          }\n          \n          ui {\n              enabled = true\n          \n              consul {\n                  ui_url = \"https://consul.spr.ocket.dev\"\n              }\n              vault {\n                  ui_url = \"https://vault.spr.ocket.dev\"\n              }\n          }\n    - path: /etc/assets/nomad_1.6.2_linux_amd64.zip\n      mode: 0644\n      overwrite: true\n      contents:\n        source: https://releases.hashicorp.com/nomad/1.6.2/nomad_1.6.2_linux_amd64.zip\n    - path: /etc/nomad.d/nomad.env\n      mode: 0600\n      overwrite: false\n      contents:\n        inline: \"\"\n\n  directories:\n    - path: /opt/nomad\n    - path: /etc/assets",
              "variant: flatcar\nversion: 1.0.0\n\nsystemd:\n  units:\n    - name: \"prepare-tailscale.service\"\n      enabled: true\n      contents: |\n        [Unit]\n        Description=Downloads and \"ups\" the tailscale daemon\n        After=network-online.target\n        Requires=network-online.target\n\n        [Service]\n        Type=oneshot\n        Restart=on-failure\n        RemainAfterExit=yes\n        ExecStart=/etc/assets/prepare-tailscale.sh\n\n        [Install]\n        WantedBy=multi-user.target\n    \n    - name: \"tailscaled.service\"\n      enabled: false\n      contents: |\n        [Unit]\n        Description=Tailscale node agent\n        Documentation=https://tailscale.com/kb/\n        Wants=network-online.target\n        After=network-online.target NetworkManager.service systemd-resolved.service\n\n        [Service]\n        ExecStartPre=/opt/bin/tailscaled --cleanup\n        ExecStart=/opt/bin/tailscaled --state=/opt/tailscale/tailscaled.state --socket=/run/tailscale/tailscaled.sock --port=46461\n        ExecStopPost=/opt/bin/tailscaled --cleanup\n\n        Restart=on-failure\n        RestartSec=2\n\n        RuntimeDirectory=tailscale\n        RuntimeDirectoryMode=0755\n        StateDirectory=tailscale\n        StateDirectoryMode=0700\n        CacheDirectory=tailscale\n        CacheDirectoryMode=0750\n        Type=notify\n\n        [Install]\n        WantedBy=multi-user.target\n\nstorage:\n  directories:\n    - path: /etc/assets\n    - path: /opt/tailscale\n  files:\n    - path: /etc/assets/tailscale_1.50.1_amd64.tgz\n      mode: 0644\n      overwrite: true\n      contents:\n        source: https://pkgs.tailscale.com/stable/tailscale_1.50.1_amd64.tgz\n    \n    - path: /etc/assets/tailscale-authkey\n      mode: 0600\n      overwrite: true\n      contents: \n        inline: \"tskey-auth-kMbxHC5CNTRL-bFZDhMRjAEg3r9tacS2kEgTzGtNQXbXG\"\n\n    - path: /etc/assets/prepare-tailscale.sh\n      mode: 0700\n      overwrite: true\n      contents:\n        inline: |\n          #!/usr/bin/env bash\n          set -e\n            tar -xf /etc/assets/tailscale_1.50.1_amd64.tgz -C /opt/bin --strip-components 1 --wildcards \"**/tailscale\" \"**/tailscaled\"\n            systemctl enable --now tailscaled\n            /opt/bin/tailscale up --auth-key $(cat /etc/assets/tailscale-authkey)\n            rm /etc/assets/tailscale-authkey\n"
            ],
            "strict": true
          },
          "sensitive_attributes": [
            [
              {
                "type": "get_attr",
                "value": "snippets"
              },
              {
                "type": "index",
                "value": {
                  "value": 1,
                  "type": "number"
                }
              }
            ],
            [
              {
                "type": "get_attr",
                "value": "snippets"
              },
              {
                "type": "index",
                "value": {
                  "value": 5,
                  "type": "number"
                }
              }
            ]
          ]
        }
      ]
    },
    {
      "mode": "data",
      "type": "digitalocean_image",
      "name": "flatcar",
      "provider": "provider[\"registry.opentofu.org/digitalocean/digitalocean\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "created": "2023-10-20T12:48:20Z",
            "description": "See https://www.flatcar.org/docs/latest/installing/cloud/digitalocean",
            "distribution": "Unknown OS",
            "error_message": "",
            "id": 142727941,
            "image": "142727941",
            "min_disk_size": 7,
            "name": "Flatcar Container Linux",
            "private": true,
            "regions": [
              "nyc3"
            ],
            "size_gigabytes": 0.4,
            "slug": "",
            "source": "user",
            "status": "available",
            "tags": [],
            "type": "custom"
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "mode": "data",
      "type": "digitalocean_reserved_ip",
      "name": "proxy_floating_ip",
      "provider": "provider[\"registry.opentofu.org/digitalocean/digitalocean\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "droplet_id": null,
            "id": "143.244.220.161",
            "ip_address": "143.244.220.161",
            "region": "nyc3",
            "urn": "do:reservedip:143.244.220.161"
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "mode": "managed",
      "type": "digitalocean_droplet",
      "name": "public_node",
      "provider": "provider[\"registry.opentofu.org/digitalocean/digitalocean\"]",
      "instances": [
        {
          "schema_version": 1,
          "attributes": {
            "backups": false,
            "created_at": "2023-10-26T17:59:21Z",
            "disk": 60,
            "droplet_agent": null,
            "graceful_shutdown": false,
            "id": "381764164",
            "image": "142727941",
            "ipv4_address": "167.71.111.103",
            "ipv4_address_private": "10.108.0.3",
            "ipv6": false,
            "ipv6_address": "",
            "locked": false,
            "memory": 2048,
            "monitoring": false,
            "name": "sprocket-ingress",
            "price_hourly": 0.02679,
            "price_monthly": 18,
            "private_networking": true,
            "region": "nyc3",
            "resize_disk": true,
            "size": "s-2vcpu-2gb",
            "ssh_keys": [
              "39800616"
            ],
            "status": "active",
            "tags": [
              "tofu"
            ],
            "timeouts": null,
            "urn": "do:droplet:381764164",
            "user_data": "05c1a805a7ee1cda9b8ef60b92eea9ef2cfa2f5e",
            "vcpus": 2,
            "volume_ids": [
              "62a111e5-7429-11ee-aa1c-0a58ac146f71"
            ],
            "vpc_uuid": "372b19bd-1d6a-4bdd-9d88-141a3dacd2f3"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjozNjAwMDAwMDAwMDAwLCJkZWxldGUiOjYwMDAwMDAwMDAwLCJ1cGRhdGUiOjM2MDAwMDAwMDAwMDB9LCJzY2hlbWFfdmVyc2lvbiI6IjEifQ==",
          "dependencies": [
            "data.ct_config.ignition",
            "data.digitalocean_image.flatcar",
            "digitalocean_ssh_key.portal_sprocket",
            "digitalocean_volume.public_node_persistent",
            "random_password.vault_password"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "digitalocean_reserved_ip_assignment",
      "name": "public_node_ip",
      "provider": "provider[\"registry.opentofu.org/digitalocean/digitalocean\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "droplet_id": 381764164,
            "id": "381764164-143.244.220.161-20231026180003279300000001",
            "ip_address": "143.244.220.161"
          },
          "sensitive_attributes": [],
          "private": "bnVsbA==",
          "dependencies": [
            "data.ct_config.ignition",
            "data.digitalocean_image.flatcar",
            "data.digitalocean_reserved_ip.proxy_floating_ip",
            "digitalocean_droplet.public_node",
            "digitalocean_ssh_key.portal_sprocket",
            "digitalocean_volume.public_node_persistent",
            "random_password.vault_password"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "digitalocean_ssh_key",
      "name": "portal_sprocket",
      "provider": "provider[\"registry.opentofu.org/digitalocean/digitalocean\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "fingerprint": "d3:9c:bb:41:dc:c1:8c:5d:97:ab:88:07:86:30:4a:bb",
            "id": "39800616",
            "name": "portal_sproc",
            "public_key": "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOC4Qx8/Q9DX6JiEVhLFZlmZpw6WPUnuEMHMHGXM+e8S tofu"
          },
          "sensitive_attributes": [],
          "private": "bnVsbA=="
        }
      ]
    },
    {
      "mode": "managed",
      "type": "digitalocean_volume",
      "name": "public_node_persistent",
      "provider": "provider[\"registry.opentofu.org/digitalocean/digitalocean\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "description": null,
            "droplet_ids": [],
            "filesystem_label": "tofu_public_opt",
            "filesystem_type": "ext4",
            "id": "62a111e5-7429-11ee-aa1c-0a58ac146f71",
            "initial_filesystem_label": "tofu_public_opt",
            "initial_filesystem_type": "ext4",
            "name": "public-node-opt",
            "region": "nyc3",
            "size": 10,
            "snapshot_id": null,
            "tags": [
              "tofu"
            ],
            "urn": "do:volume:62a111e5-7429-11ee-aa1c-0a58ac146f71"
          },
          "sensitive_attributes": [],
          "private": "bnVsbA=="
        }
      ]
    },
    {
      "mode": "managed",
      "type": "random_password",
      "name": "vault_password",
      "provider": "provider[\"registry.opentofu.org/hashicorp/random\"]",
      "instances": [
        {
          "schema_version": 3,
          "attributes": {
            "bcrypt_hash": "$2a$10$qf3CBviqzNb2UuLawdH0x.4jhU0wPCkOJ.VJETqlNsyQwALEaVRVe",
            "id": "none",
            "keepers": null,
            "length": 64,
            "lower": true,
            "min_lower": 0,
            "min_numeric": 0,
            "min_special": 0,
            "min_upper": 0,
            "number": true,
            "numeric": true,
            "override_special": "!@$%\u0026()-=+[]{}?:.",
            "result": "Cs?N6q.peex4w-8Y9RX1rW6U9dY=p-tMMdI9!]bAhL?zuKC?Rf%)UHcgrb1faEs=",
            "special": true,
            "upper": true
          },
          "sensitive_attributes": []
        }
      ]
    }
  ],
  "check_results": null
}
